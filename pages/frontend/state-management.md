# 状態管理

このドキュメントでは、当プロジェクトにおける状態管理について説明します。

## 方針

当プロジェクトでは、Reduxなどのアプリケーションの状態を一元管理する方法を採用せず、代わりに各状態管理に特化したライブラリを採用することに決めました。その理由は次のとおりです。

Reduxを使うと、イミュータブルなデータをグローバルストアで管理でき、Prop Drilling（バケツリレー）問題を解決できますが、重たいボイラープレートが必要になります。その結果、コード量が増え、冗長性が生じ、開発者の生産性が低下することがあります。さらに、複数のファイルやディレクトリにまたがるボイラープレートが原因で構造が複雑になり、可読性が低下し、バグの特定やリファクタリングが難しくなります。

このため、多くのプロジェクトではReduxは過剰と感じられます。そこで、各状態管理に特化したライブラリを採用することにしました。各ライブラリの機能を適切に利用することで、プロジェクト全体の状態管理が効率的になり、開発速度やメンテナンス性が向上することが期待できます。

### コンポーネント

コンポーネントの状態管理について説明します。基本的にコンポーネントの状態は外部と共有されることは想定されていませんが、必要に応じて子コンポーネントにpropとして渡すことができます。状態管理をコンポーネントレベルで始め、アプリケーション全体で状態の共有が必要になったら、移行を検討してください。

コンポーネントの状態管理には主に2つの方法があります。

#### useState

Reactの[useState](https://react.dev/reference/react/useState) Hookは、コンポーネント内で状態を管理できる方法です。useStateを使うことで、状態を保持し更新することが可能です。

#### useReducer

もっと複雑な状態管理が必要な場合は、[useReducer](https://react.dev/reference/react/useReducer) Hookを使います。useReducerは状態とアクションを受け取り、新しい状態を返すReducerを使用して状態を管理します。

### アプリケーション

アプリケーションの状態管理は、アプリケーション全体で共有される状態を一元的に管理することです。例えば、通知やカラーモードなどの設定があります。カラーモードの状態を一元的に管理することで、アプリケーション内のすべてのコンポーネントで適切な色を表示することができます。

アプリケーションの状態を管理するライブラリとして、jotaiを採用しています。

#### jotai

[Jotai](https://jotai.org/)は、Recoilにインスパイアされたグローバル状態管理ライブラリで、atomicアプローチを採用しています。状態管理は、atomという最小単位の状態を利用して行われます。atomは他のatomに依存することができ、それらの依存関係を基に自動的にレンダリングが最適化されます。これにより、Reactコンテキストにおける不要な再レンダリング問題が解決し、メモ化の必要性もなくなります。

### サーバーキャッシュ

サーバーキャッシュの状態管理は、アプリケーションがサーバーから取得したデータをキャッシュに保存し、同じデータが必要になった場合には、キャッシュから提供する仕組みです。異なる場所から同じキーでデータを要求しても、データは一度だけ取得され、重複リクエストが避けられます。この仕組みによって、アプリケーション内でサーバーから取得したデータを再利用することができます。

さらに、状態管理ライブラリは、アプリケーションがデータを所有していないと仮定し、サーバーとデータの同期を行い、最新の状態を維持しやすくする機能を提供しています。また、データの再取得をスマートに行う戦略も提供されています。

#### TanStack Query (FKA React Query)

RESTの状態管理ライブラリとして、[TanStack Query](https://tanstack.com/query/latest/)を採用しています。

#### URQL GraphQL

GraphQLの状態管理ライブラリとして、[URQL](https://formidable.com/open-source/urql/)を採用しています。URQLは、[Document Caching](https://formidable.com/open-source/urql/docs/basics/document-caching/)という手法を活用し、各クエリの結果をキャッシュして、同じリクエストが何度も送信されるのを防ぎます。これはブラウザのキャッシュのように動作します。URQLでは、送信されるリクエストのキーを、クエリとその変数に基づいて生成します。

### フォーム

フォームの状態管理について説明します。これは、ユーザーが入力した値を管理するために用いられます。

Reactの[Form components](https://react.dev/reference/react-dom/components#form-components)を利用することで、`value` propを通じて制御が可能です。これにより、さまざまなフォームを作成することができます。しかし、アプリケーションの要件によっては、複雑なフィールドやバリデーションが必要になることがあります。

このような場合、フォームの状態管理に特化したライブラリを利用することで、状態管理を適切に実装できます。当プロジェクトでは、[Mantine Form](https://mantine.dev/form/use-form/)を採用しています。
また、バリデーションのライブラリには、[zod](https://zod.dev/)を採用しています。

#### 使用例

Mantine Formとzodを組み合わせた使用例を見たい方は、[こちらのリンク](https://mantine.dev/form/validation/#zod)をクリックしてください。このページでは、具体的な実装例が紹介されています。

## 参考

- [Bulletproof React / State Management](https://github.com/alan2207/bulletproof-react/blob/master/docs/state-management.md)
- [「3種類」で管理するReactのState戦略](https://zenn.dev/yoshiko/articles/607ec0c9b0408d)
- [Practical React Query](https://tkdodo.eu/blog/practical-react-query)
- [React Query as a State Manager](https://tkdodo.eu/blog/react-query-as-a-state-manager)
